# Testing the VTL grammar
The VTL EBNF grammar has been built according to the VTL Reference and User Manuals. As of v2.0 of VTL, the ANTL4 maven plugin has been used in order to generate the appropriate Java classes of the the VTL grammar and use jUnit tests to ensure the desired behaviour of the grammar. To achieve that, three types of tests have been used:
- Positive tests (using all Reference Manual samples);
- Negative tests (creating bad syntax for most of the Reference Manual samples);
- Complex tests (combining many VTL expressions, and assessing the generated Abstract Syntax Tree against anticipated trees â€“ using Antlr4 `TestRig` tool).

For this reason, the GitHub project has been restructured to include the Vtl files within the required folders. You may access them in their new place:

[`src/main/antlr4/org/sdmx/vtl/Vtl.g4`](src/main/antlr4/org/sdmx/vtl/Vtl.g4)

[`src/main/antlr4/imports/VtlTokens.g4`](src/main/antlr4/imports/VtlTokens.g4)

## Project structure
As mentioned above, this is a maven project that uses jUnit 4 test classes, in order to parse the input VTL expressions, validate their syntax and generate their ASTs. Please check the [pom.xml](pom.xml) file for the details on the project requirements.

### The test files
The jUnit tests are dynamically generated by parsing the appropriate text files that include the expressions to test. Two consecutive new lines would separate the VTL expressions within one jUnit test. See the corresponding files for the groups of tests:
- [PositiveTests.vtl](src/test/resources/PositiveTests.vtl)
- [NegativeTests.vtl](src/test/resources/NegativeTests.vtl)
- [ComplexTests.vtl](src/test/resources/ComplexTests.vtl)

### The ErrorListener
For validating the VTL expressions against the EBNF grammar, a simple ErrorListener has been developed; see here:

[`src/main/java/antlr4/org/sdmx/vtl/VtlErrorListener.java`](src/main/java/antlr4/org/sdmx/vtl/VtlErrorListener.java)

### The Abstract Syntax Tree (AST)
For validating the generated AST of a VTL expression (or set of expressions) the class [`VtlTreeGenerator.java`](src/test/java/antlr4/org/sdmx/vtl/VtlTreeGenerator.java) has been added in the test classes. This class uses the generated VTLParser class, created by the antlr4 plugin. The AST is a string, which, although not too user friendly, may be used to test the generated tree against an anticipated tree, as generated by the `TestRig` tool included in Antlr4.

### Running the tests
In order to run the jUnit tests from the command line, the surefire maven plugin is being utilised. Hence, in order to run the tests, simply execute:

`$ mvn test`

For testing only specific tests, you may use the -Dtest parameter. For example, testing only the negative tests:

`$ mvn test -Dtest=NegativeTests`

### Building an executable and running tests on terminal
In order to build a single `.jar` executable, all you need is to run the following:

`$ mvn clean compile assembly:single`

This will create a `.jar` file with the required Antlr4 dependencies. If you cannot run maven, see the target folder for the latest version of this `.jar`.

Following that you may run the standalone `.jar` by:

`$ java -cp target/ebnf-1.0.0-jar-with-dependencies.jar org.antlr.v4.gui.TestRig org.sdmx.vtl.Vtl start -gui`

This uses the Antlr4 TestRig class which validates any expression in the input and generates a graphical tree of this expression. Following that, you may insert a VTL expression and then press Ctrl+D. This will validate the expression and generate a graphical tree.

Alternatively, you may provide a file with VTL expressions as the last argument, i.e.:

`$ java -cp target/ebnf-1.0.0-jar-with-dependencies.jar org.antlr.v4.gui.TestRig org.sdmx.vtl.Vtl start vtl-expressions.txt`